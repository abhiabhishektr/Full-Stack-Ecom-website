<%-include('../layout/adminHeader')-%>

  <div class="container-fluid" style="margin-top: 50px;">
    <h2 style="margin-bottom: 20px;">Add Coupons</h2>

    <form id="addCouponForm">
      <div class="form-row">
        <div class="form-group col-md-6" style="margin-bottom: 16px;">
          <label for="code">Coupon Code:</label>
          <input type="text" class="form-control" id="code" name="code" required>
        </div>

        <div class="form-group col-md-6" style="margin-bottom: 16px;">
          <label for="discountType">Discount Type:</label>
          <select class="form-control" id="discountType" name="discountType" required>
            <option value="percentage">Percentage</option>
            <option value="fixed">Fixed Amount</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group col-md-6" style="margin-bottom: 16px;">
          <label for="startDate">Start Date:</label>
          <input type="date" class="form-control" id="startDate" name="startDate" required>
        </div>


        <div class="form-group col-md-6" style="margin-bottom: 16px;">
          <label for="expirationDate">Expiration Date:</label>
          <input type="date" class="form-control" id="expirationDate" name="expirationDate" required>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group col-md-6" style="margin-bottom: 16px;">
          <label for="discountAmount">Discount Amount:</label>
          <input type="number" class="form-control" id="discountAmount" name="discountAmount" required>
        </div>

        <div class="form-group col-md-6" style="margin-bottom: 16px;">
          <label for="minOrderAmount">Minimum Order Amount:</label>
          <input type="number" class="form-control" id="minOrderAmount" name="minOrderAmount">
        </div>
      </div>
      <div id="errorContainer" style="color: red; margin-bottom: 16px;"></div>
      <button type="button" class="btn btn-success" onclick="addCoupon()"
        style="background-color: #28a745; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer;">Add
        Coupon</button>
    </form>

    <h2 style="margin-top: 40px;">Existing Coupons</h2>

    <table class="table">
      <thead>
        <tr>
          <th>Coupon Code</th>
          <th>Discount Type</th>
          <th>Start Date</th>
          <th>Expiration Date</th>
          <th>Discount Amount</th>
          <th>Min Order Amount</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        <% existingCoupons.forEach(coupon=> { %>
          <tr>
            <td>
              <%= coupon.code %>
            </td>
            <td>
              <%= coupon.discountType %>
            </td>
            <td>
              <%= coupon.startDate.toISOString().split('T')[0] %>
            </td>
            <td>
              <%= coupon.expirationDate.toISOString().split('T')[0] %>
            </td>
            <td>
              <%= coupon.discountType==='percentage' ? coupon.discountAmount * 100 + '%' : coupon.discountAmount %>
            </td>
            <td>
              <%= coupon.minOrderAmount %>
            </td>
            <td>
              <% if (coupon.couponActive) { %>
                <button class="btn btn-sm btn-primary" onclick="activateCoupon('<%= coupon._id %>')">Activate</button>
                <% } else { %>
                  <button class="btn btn-sm btn-warning"
                    onclick="deactivateCoupon('<%= coupon._id %>')">Deactivate</button>
                  <% } %>
                    <button class="btn btn-sm btn-danger" onclick="deleteCoupon('<%= coupon._id %>')">Delete</button>
                    <button class="btn btn-sm btn-info" onclick="updateCoupon('<%= coupon._id %>')">Update</button>
            </td>

          </tr>
          <% }) %>
      </tbody>
    </table>
  </div>

  <script>
    function activateCoupon(couponId) {
      // Add logic to activate the coupon
      console.log('Activate coupon with ID:', couponId);
    }

    function deactivateCoupon(couponId) {
      // Add logic to deactivate the coupon
      console.log('Deactivate coupon with ID:', couponId);
    }

    function deleteCoupon(couponId) {
      // Add logic to delete the coupon
      console.log('Delete coupon with ID:', couponId);
    }

    function updateCoupon(couponId) {
      // Add logic to update the coupon
      console.log('Update coupon with ID:', couponId);
    }
  </script>



  </div>



  <script>
    async function addCoupon() {
      const code = document.getElementById('code').value;
      const discountType = document.getElementById('discountType').value;
      const discountAmount = document.getElementById('discountAmount').value;
      const startDate = document.getElementById('startDate').value; // Add this line
      const expirationDate = document.getElementById('expirationDate').value;
      const minOrderAmount = document.getElementById('minOrderAmount').value;

      console.log(discountType);


      const errorContainer = document.getElementById('errorContainer');
      errorContainer.innerHTML = ''; // Clear previous errors

      if (!code || code.includes(' ')) {
        errorContainer.innerHTML = 'Please enter a valid coupon code without spaces.';
        return;
      }

      if (minOrderAmount && minOrderAmount > discountAmount) {
        errorContainer.innerHTML = 'Minimum order amount should not be greater than the discount amount.';
        return;
      }

      const startDateObj = new Date(startDate);
      const expirationDateObj = new Date(expirationDate);

      if (startDateObj > expirationDateObj) {
        errorContainer.innerHTML = 'Start date should not be greater than expiration date.';
        return;
      }

      if (discountAmount < 0 || minOrderAmount < 0) {
        errorContainer.innerHTML = 'Discount amount and minimum order amount must not be negative.';
        return;
      }





      try {
        const response = await fetch('/CouponsAdmin', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            code,
            discountType,
            discountAmount: parseFloat(discountAmount),
            startDate,
            expirationDate,
            minOrderAmount: minOrderAmount ? parseFloat(minOrderAmount) : undefined,
          }),
        });

        if (response.ok) {
          const data = await response.json();

          // Update the HTML to display the new list of coupons
          updateCouponList(data.coupons);

          alert('Coupon added successfully!');
          document.getElementById('addCouponForm').reset();
        } else {
          const data = await response.json();
          alert(`Error: ${data.error}`);
        }
      } catch (error) {
        console.error('Error adding coupon:', error);
        alert('An error occurred while adding the coupon. Please try again.');
      }
    }

    function updateCouponList(coupons) {
      const tableBody = document.querySelector('#couponTable tbody');
      tableBody.innerHTML = '';

      coupons.forEach(coupon => {
        const row = tableBody.insertRow();
        row.innerHTML = `
          <td>${coupon.code}</td>
          <td>${coupon.discountType}</td>
          <td>${coupon.startDate}</td>
          <td>${coupon.expirationDate}</td>
          <td>${coupon.discountType === 'percentage' ? coupon.discountAmount * 100 + '%' : coupon.discountAmount}</td>
          <td>${coupon.minOrderAmount}</td>
          <td>
              <button class="btn btn-primary" onclick="activateCoupon('${coupon._id}')">Activate</button>
              <button class="btn btn-warning" onclick="deactivateCoupon('${coupon._id}')">Deactivate</button>
              <button class="btn btn-danger" onclick="deleteCoupon('${coupon._id}')">Delete</button>
              <button class="btn btn-info" onclick="updateCoupon('${coupon._id}')">Update</button>
          </td>`;
      });
    }

  </script>





  </div>
  <script src="/admin/src/assets/libs/jquery/dist/jquery.min.js"></script>
  <script src="/admin/src/assets/libs/popper.js/dist/umd/popper.min.js"></script>
  <script src="/admin/src/assets/libs/bootstrap/dist/js/bootstrap.min.js"></script>
  <!-- apps -->
  <!-- apps -->
  <script src="/admin/src/dist/js/app-style-switcher.js"></script>
  <script src="/admin/src/dist/js/feather.min.js"></script>
  <script src="/admin/src/assets/libs/perfect-scrollbar/dist/perfect-scrollbar.jquery.min.js"></script>
  <script src="/admin/src/dist/js/sidebarmenu.js"></script>
  <!--Custom JavaScript -->
  <script src="/admin/src/dist/js/custom.min.js"></script>
  <!--This page JavaScript -->
  <script src="/admin/src/assets/extra-libs/c3/d3.min.js"></script>
  <script src="/admin/src/assets/extra-libs/c3/c3.min.js"></script>
  <script src="/admin/src/assets/libs/chartist/dist/chartist.min.js"></script>
  <script src="/admin/src/assets/libs/chartist-plugin-tooltips/dist/chartist-plugin-tooltip.min.js"></script>
  <script src="/admin/src/assets/extra-libs/jvector/jquery-jvectormap-2.0.2.min.js"></script>
  <script src="/admin/src/assets/extra-libs/jvector/jquery-jvectormap-world-mill-en.js"></script>
  <script src="/admin/src/dist/js/pages/dashboards/dashboard1.min.js"></script>
  </body>

  </html>