<%-include('../layout/adminHeader')-%>


<div class="container-fluid mt-4">
    <h1 class="mb-4">Orders Admin</h1>

    <div class="table-responsive">
        <table class="table table-bordered">
            <thead class="thead-dark">
                <tr>
                    <th class="w-5" >User</th>
                    <th>Product Name</th>
                    <th>Price</th>
                    <th>Quantity</th>
                    <th>Total</th>
                    <th class="d-none d-md-table-cell">Order Status</th>
                    <th>Payment Mode</th>
                    <th class="d-none d-md-table-cell">Date</th>
                    <th>Update Status</th> <!-- Added column for the update button -->
                    <!-- Add additional columns as needed -->
                </tr>
            </thead>
            <tbody>
                <% orders.reverse().forEach(order => { %>
                    <% order.Products.reverse().forEach(product => { %>
                        <tr>
                            <td class="w-5" style="font-size: 12px; line-height: 1; padding: 6px; height: 20px;"><%= order._id %></td>
                            <td><%= product.products.name %></td>
                            <td>$<%= product.price.toFixed(2) %></td>
                            <td><%= product.quantity %></td>
                            <td>$<%= product.total.toFixed(2) %></td>
                            <!-- <%= product.orderStatus %> -->
                            <td class="d-none d-md-table-cell">
                                <select class="form-select" name="orderStatus"  id="<%= order._id %>">
                                    <option disabled selected style="color: gray;" value=""><%= order.orderStatus %></option>
                                    <option <%= order.orderStatus === 'placed' ? 'selected' : '' %> value="placed">Placed</option>
                                    <option <%= order.orderStatus === 'shipped' ? 'selected' : '' %> value="shipped">Shipped</option>
                                    <option <%= order.orderStatus === 'delivered' ? 'selected' : '' %> value="delivered">Delivered</option>
                                    <option <%= order.orderStatus === 'request return' ? 'selected' : '' %> value="request return">Request Return</option>
                                    <option <%= order.orderStatus === 'returned' ? 'selected' : '' %> value="returned">Returned</option>
                                    <option <%= order.orderStatus === 'request cancellation' ? 'selected' : '' %> value="request cancellation">Request Cancellation</option>
                                    <option <%= order.orderStatus === 'cancelled' ? 'selected' : '' %> value="cancelled">Cancelled</option>
                                </select>
                                <div id="updateMessage_<%= order._id %>"></div>

                            </td>
                          
                            <td><%= order.paymentMode %></td>
                            <td class="d-none d-md-table-cell"><%= order.date.toLocaleDateString() %></td>
                            <td>
                                <button class="btn btn-primary" onclick="updateOrderStatus('<%= order._id %>')">Update</button>
                                
                            </td>
                            
                            <!-- Add additional cells based on your model structure -->
                        </tr>
                    <% }); %>
                <% }); %>
            </tbody>
        </table>
    </div>
</div>

<script>
    async function updateOrderStatus(orderId) {
        try {
            // Get the selected value from the dropdown
            const selectedStatus = document.getElementById(orderId).value;

            // Get the message element
            const messageElement = document.getElementById(`updateMessage_${orderId}`);

            // Send an AJAX request to update the order status
            const response = await fetch(`OrdersStatus/${orderId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ orderStatus: selectedStatus }),
            });

            if (response.ok) {
                const updatedOrder = await response.json();
                // Update successful, you can perform additional actions if needed
                console.log(`Order ${orderId} status updated to: ${selectedStatus}`);
                // Display a success message
                messageElement.textContent = `Updated : ${selectedStatus}`;
                messageElement.style.color = 'green'; // Set color to green for success
            } else {
                // Handle errors or provide user feedback
                console.error(`Error updating order status: ${response.statusText}`);
                // Display an error message
                messageElement.textContent = `Error updating order status: ${response.statusText}`;
                messageElement.style.color = 'red'; // Set color to red for error
            }
        } catch (error) {
            // Handle any errors
            console.error(error);
        }
    }
</script>

<!-- Add this element in your HTML where you want to display the message -->







<%-include('../layout/adminFoot')-%>